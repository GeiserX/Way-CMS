services:
  # Public website served via nginx
  website:
    image: nginx:alpine
    container_name: way-cms-website
    ports:
      - "8080:80"
    volumes:
      - ./website:/usr/share/nginx/html:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      - way-cms-network

  # CMS admin interface
  cms:
    build:
      context: ./cms
      dockerfile: Dockerfile
    container_name: way-cms-admin
    ports:
      - "5001:5000"
    volumes:
      - ./website:/var/www/html:rw
      - ./.way-cms-backups:/.way-cms-backups
    environment:
      - CMS_BASE_DIR=/var/www/html
      - CMS_USERNAME=${CMS_USERNAME:-admin}
      - CMS_PASSWORD=${CMS_PASSWORD:-admin}
      - CMS_PASSWORD_HASH=${CMS_PASSWORD_HASH:-}
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production-please}
      - WEBSITE_URL=${WEBSITE_URL:-}
      - WEBSITE_NAME=${WEBSITE_NAME:-}
      - PORT=5000
      - FLASK_APP=app.py
    restart: unless-stopped
    networks:
      - way-cms-network
    depends_on:
      - website

networks:
  way-cms-network:
    driver: bridge

volumes:
  website-data:
    driver: local